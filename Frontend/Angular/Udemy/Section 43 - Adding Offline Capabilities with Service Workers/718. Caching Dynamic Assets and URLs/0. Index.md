# 718. Caching Dynamic Assets & URLs

> Duração: `7min`

## Recursos
- ng-pwa-02-finished.zip


WEBVTT

00:03.210 --> 00:04.410
-: Regarding the API,

00:04.410 --> 00:06.033
we can also prefetch this.

00:07.050 --> 00:09.870
For that, we add a new configuration item,

00:09.870 --> 00:11.880
and that would be data groups.

00:11.880 --> 00:13.530
Remember we got asset groups here

00:13.530 --> 00:15.420
for the static files essentially,

00:15.420 --> 00:17.340
data groups is for dynamic data.

00:17.340 --> 00:20.190
So typically data you request from an API,

00:20.190 --> 00:22.740
data that might change frequently.

00:22.740 --> 00:25.140
How is a data group configured?

00:25.140 --> 00:28.320
It is an array because it's data groups here,

00:28.320 --> 00:30.030
but one data group is then again

00:30.030 --> 00:32.283
an object just as an asset group.

00:33.150 --> 00:38.150
You then define a name of your choice, like posts,

00:38.760 --> 00:40.530
but that name is totally up to you.

00:40.530 --> 00:44.310
And then you define URLs you want to handle with this group.

00:44.310 --> 00:46.560
And in my case, that is the URL

00:46.560 --> 00:49.230
I can see in my app component,

00:49.230 --> 00:51.570
which is where I make this HDP request

00:51.570 --> 00:53.670
this URL to JSON placeholder.

00:53.670 --> 00:54.630
This is what I'll take

00:54.630 --> 00:58.440
and this is what I'll put into the URL's array as a string.

00:58.440 --> 01:01.080
You could now also add a version here.

01:01.080 --> 01:02.250
If you got an API

01:02.250 --> 01:05.250
which might have different versions and the version changed

01:05.250 --> 01:08.220
then you could lock the version in here to

01:08.220 --> 01:12.180
for example, cache different data pieces

01:12.180 --> 01:14.640
side by side for different API versions.

01:14.640 --> 01:16.950
Here, I will not use the version.

01:16.950 --> 01:21.360
And instead what you can add here is a cache config.

01:21.360 --> 01:24.360
This is another object where you can now in detail configure

01:24.360 --> 01:26.760
how this data should be cached.

01:26.760 --> 01:30.240
And for that you can, for example, set a max size.

01:30.240 --> 01:31.860
This is a number and this defines

01:31.860 --> 01:34.080
how many entries do you want to cache.

01:34.080 --> 01:35.160
And now that's important.

01:35.160 --> 01:38.340
This does not mean how many posts, for example

01:38.340 --> 01:40.920
this means how many responses.

01:40.920 --> 01:43.170
Now, for this single URL

01:43.170 --> 01:46.170
we will only cache one response at a time.

01:46.170 --> 01:49.560
But if you had a more generic URL with a star let's say

01:49.560 --> 01:51.270
for different end points,

01:51.270 --> 01:53.512
then you might want to make sure that only for 10

01:53.512 --> 01:56.550
outgoing requests the answer was cached

01:56.550 --> 01:59.280
to not pollute your cache and grow it infinitely

01:59.280 --> 02:02.040
because your space is actually limited

02:02.040 --> 02:03.540
and managed by the browser.

02:03.540 --> 02:05.700
So you don't want to cache everything.

02:05.700 --> 02:08.310
So here we could say cache five responses.

02:08.310 --> 02:10.950
Again, for this example, it doesn't matter.

02:10.950 --> 02:15.840
We can then also add max H to define how old should the data

02:15.840 --> 02:18.360
in the cache be before we get rid of it.

02:18.360 --> 02:20.340
And definitely fetch new data.

02:20.340 --> 02:23.910
Because you might want to fetch from cache first

02:23.910 --> 02:27.060
to deliver something onto the screen as quick as possible,

02:27.060 --> 02:29.670
and then maybe reach out to more up to date data

02:29.670 --> 02:30.750
behind the scenes.

02:30.750 --> 02:32.730
But for that, you of course need to know

02:32.730 --> 02:34.980
is the data and the cache still valid

02:34.980 --> 02:37.890
or should I always fetch new data?

02:37.890 --> 02:41.340
This is defined as a string, which you write like this.

02:41.340 --> 02:45.570
You could say one day or 12 hours or 50 minutes.

02:45.570 --> 02:47.400
This is essentially the format you have.

02:47.400 --> 02:49.560
Details can be found in the official docs

02:49.560 --> 02:52.530
and you find a link to that attached to this video too.

02:52.530 --> 02:55.320
So here I'll go with let's say six hours

02:55.320 --> 02:57.810
and then you can also add a timeout.

02:57.810 --> 02:59.760
The timeout is defined in the same way.

02:59.760 --> 03:02.880
And there you could say, if I'm waiting for a response

03:02.880 --> 03:06.330
for let's say 10 seconds already

03:06.330 --> 03:09.750
then I want to fall back to the cache and not wait longer.

03:09.750 --> 03:12.060
But I don't wanna use the cache immediately.

03:12.060 --> 03:14.550
I wanna wait for these 10 seconds at least.

03:14.550 --> 03:17.160
So I could say 10 seconds here.

03:17.160 --> 03:19.050
Last but not least, and that's important

03:19.050 --> 03:21.570
because it works together with the above values,

03:21.570 --> 03:22.650
the strategy.

03:22.650 --> 03:25.200
There you can have two types of strategy,

03:25.200 --> 03:28.200
freshness, which means always try to reach out

03:28.200 --> 03:30.420
to the back end first and only use the cache

03:30.420 --> 03:32.040
if you're offline.

03:32.040 --> 03:34.290
Or performance.

03:34.290 --> 03:36.030
Performance tries to get something

03:36.030 --> 03:37.860
onto the screen as quick as possible.

03:37.860 --> 03:39.690
And it will take max age into account

03:39.690 --> 03:41.550
to know whether it should absolutely

03:41.550 --> 03:44.430
reach out to the backend or just use the cache value.

03:44.430 --> 03:47.850
On the other hand, freshness will take time out into account

03:47.850 --> 03:50.220
to know how long to wait for a response

03:50.220 --> 03:52.200
before it uses the cache.

03:52.200 --> 03:55.620
So I will go with freshness here and I will save this.

03:55.620 --> 03:57.120
And now you know the game.

03:57.120 --> 03:59.940
Let's go back and let's build this again

03:59.940 --> 04:01.809
with dash dash prod.

04:01.809 --> 04:05.280
And what we should see is that now that we built this

04:05.280 --> 04:09.720
that if we then go back to the built project and serve it

04:09.720 --> 04:13.713
that this actually then works in offline mode.

04:15.930 --> 04:20.430
So let's bring up that HDP server, reload this page.

04:20.430 --> 04:21.690
And as I mentioned before

04:21.690 --> 04:24.000
feel free to close it because a new service worker

04:24.000 --> 04:27.510
to be registered should also be able to be loaded

04:27.510 --> 04:31.110
without you closing that tab and opening a new one.

04:31.110 --> 04:34.320
Angler can handle that, but by default

04:34.320 --> 04:35.670
this is required by default,

04:35.670 --> 04:38.970
for a new service worker to go active or to turn active

04:38.970 --> 04:42.360
and do its job, you need to reload the page.

04:42.360 --> 04:46.860
Also, because Angler does not use the new updated code

04:46.860 --> 04:48.540
you might ship onto the server

04:48.540 --> 04:50.910
and load it into your already running app

04:50.910 --> 04:53.520
because that might break your already running app.

04:53.520 --> 04:55.890
So close the tab, open a new one.

04:55.890 --> 04:57.960
Now in that new tab, reload at least once

04:57.960 --> 05:01.980
so that the API responses can be cached.

05:01.980 --> 05:03.810
The first we load loads the service worker

05:03.810 --> 05:06.360
the second one loads the API responses

05:06.360 --> 05:09.090
then turn off the wifi and load again.

05:09.090 --> 05:10.140
And what you should see is

05:10.140 --> 05:14.100
that you still got your posts here.

05:14.100 --> 05:16.410
Now one thing you can notice is

05:16.410 --> 05:18.660
that the fonts are missing because,

05:18.660 --> 05:20.880
and that's just something you have to know

05:20.880 --> 05:21.930
about Google fonts,

05:21.930 --> 05:25.230
the way it's loaded, it takes two URLs.

05:25.230 --> 05:26.850
This is the URL where it goes to

05:26.850 --> 05:29.760
and tries to fetch the font then.

05:29.760 --> 05:31.590
The other URL we put in there

05:31.590 --> 05:35.190
is the one which just holds the rules for the font

05:35.190 --> 05:37.110
and then that extra url.

05:37.110 --> 05:41.040
So let's add that newly gathered information here.

05:41.040 --> 05:43.620
Now replace this at the end here with star star

05:43.620 --> 05:47.460
to load any funds from the URL, close THP server,

05:47.460 --> 05:49.020
and built this one more time

05:49.020 --> 05:52.650
as you saw it before with NG build dash dash prod.

05:52.650 --> 05:55.230
And we could already see that the API data was loaded

05:55.230 --> 05:57.360
at least so that this was present.

05:57.360 --> 05:58.980
Now with this built one more time,

05:58.980 --> 06:01.710
let's again go back to our disc folder

06:01.710 --> 06:03.610
and let's serve this one more time

06:04.560 --> 06:08.820
but then open a new tab for it to become active.

06:08.820 --> 06:11.970
Reload this one more time to store

06:11.970 --> 06:13.380
to make sure that the responses

06:13.380 --> 06:15.180
are really stored, I should say.

06:15.180 --> 06:20.180
And now let's go offline again and reload this app.

06:20.250 --> 06:22.500
And you see the fonts are there too.

06:22.500 --> 06:25.080
And in the network tab we see everything is fetched

06:25.080 --> 06:26.970
the posts fail, but that's no problem

06:26.970 --> 06:29.520
because we take that from the cache which works.

06:29.520 --> 06:31.020
You can see it here in response.

06:31.020 --> 06:31.890
There it is.

06:31.890 --> 06:34.080
And this is how we can use the service worker.

06:34.080 --> 06:36.390
The Angular service worker package,

06:36.390 --> 06:38.190
which you can easily add

06:38.190 --> 06:41.250
with the NG add at Angular PWA package

06:41.250 --> 06:43.440
which includes that service broker package

06:43.440 --> 06:45.701
which also gives you that manifest adjacent file

06:45.701 --> 06:49.230
and which overall is something you have to learn

06:49.230 --> 06:51.210
but then gives you the powerful tool

06:51.210 --> 06:54.810
of making your web app offline available.

06:54.810 --> 06:56.280
Now, check the official docs

06:56.280 --> 06:58.320
which you find attached to the video, of course.

06:58.320 --> 07:00.243
And I hope that this was helpful.
