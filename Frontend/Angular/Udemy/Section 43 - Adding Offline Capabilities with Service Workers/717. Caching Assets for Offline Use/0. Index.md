# 717. Caching Assets for Offline Use

> Duração: `5min`

Sem Recursos

WEBVTT

00:02.340 --> 00:04.710
-: Now this file is actually not that long.

00:04.710 --> 00:07.260
It's a JSON file, JSON format.

00:07.260 --> 00:09.510
And first of all, we have the index page.

00:09.510 --> 00:12.780
This indicates what is the root page of our app.

00:12.780 --> 00:14.700
We want a cache and load, and that

00:14.700 --> 00:17.700
of course is the index HTML file sitting directly

00:17.700 --> 00:21.720
in the root server folder we're serving from.

00:21.720 --> 00:24.000
And then we get a so-called asset group,

00:24.000 --> 00:25.470
or actually asset groups.

00:25.470 --> 00:26.610
It's an array.

00:26.610 --> 00:28.680
And in there we got two asset groups,

00:28.680 --> 00:30.600
these objects which we have in there.

00:30.600 --> 00:33.794
Now, asset groups are configurations that define

00:33.794 --> 00:36.306
which static assets should be cached

00:36.306 --> 00:38.340
and how they should be cached.

00:38.340 --> 00:42.180
Dynamic assets, for example, would be the data from the API.

00:42.180 --> 00:45.630
So data we're fetching which might change on that API.

00:45.630 --> 00:48.600
So it's not static, it changes frequently.

00:48.600 --> 00:51.772
Our HTML file, our JavaScript code will also change

00:51.772 --> 00:55.050
with every build, but after the build it's static.

00:55.050 --> 00:57.590
It's not changing in some database or anything like that.

00:57.590 --> 00:59.670
So that's what an asset group is.

00:59.670 --> 01:02.580
We can give such a group a name, whichever name you like.

01:02.580 --> 01:06.330
And you can then define how should these assets be loaded.

01:06.330 --> 01:08.668
Prefetch means that when your page loads

01:08.668 --> 01:12.540
Angular will go ahead, or the service worker will go ahead,

01:12.540 --> 01:16.050
and already prefetch all the assets which are specified

01:16.050 --> 01:18.240
in this assets group, which means it puts it

01:18.240 --> 01:20.691
into cache even if you haven't needed them yet.

01:20.691 --> 01:23.440
The alternative to Prefetch is Lazy.

01:23.440 --> 01:26.329
You can use that too, and that would only load them

01:26.329 --> 01:28.860
once you needed them at least once.

01:28.860 --> 01:31.230
The advantage of Lazy is, of course, that you don't

01:31.230 --> 01:33.810
occupy all the bandwidth right at the beginning.

01:33.810 --> 01:36.210
The downside is that if you need it for the first time,

01:36.210 --> 01:37.440
it will not be there.

01:37.440 --> 01:39.248
So if the user loses the internet connection

01:39.248 --> 01:41.989
before the asset, let's say the CSS file

01:41.989 --> 01:45.150
is required the first time, it will not work

01:45.150 --> 01:46.860
because it will not be cached.

01:46.860 --> 01:50.927
With Prefetch, it will be cached even before you need it.

01:50.927 --> 01:53.130
There also is a updateMode.

01:53.130 --> 01:54.533
I guess you can see it down there.

01:54.533 --> 01:57.028
Now, this is important for the case that you're

01:57.028 --> 02:00.120
pushing a new version of your Angular app,

02:00.120 --> 02:03.270
and therefore also of your service worker, to your server,

02:03.270 --> 02:05.814
and the user is already browsing on that server.

02:05.814 --> 02:09.750
And it will get informed about the new service worker.

02:09.750 --> 02:13.350
And now the service worker can already prefetch the updated

02:13.350 --> 02:17.366
assets or also load them lazily when they are required.

02:17.366 --> 02:20.190
Now the assets, which should be loaded,

02:20.190 --> 02:21.870
are the resources then.

02:21.870 --> 02:25.380
Resources has one key property, the files.

02:25.380 --> 02:28.260
And there you have an array pointing to the files

02:28.260 --> 02:29.670
you want to cache.

02:29.670 --> 02:32.520
You can point at something like the index HTML file.

02:32.520 --> 02:35.250
And this is always seen relative from the dist folder,

02:35.250 --> 02:37.080
so from the folder you will have in the end

02:37.080 --> 02:38.580
once you deploy this.

02:38.580 --> 02:42.120
But you can also set up patterns like every CSS file

02:42.120 --> 02:44.399
or every JavaScript file in the root folder.

02:44.399 --> 02:48.578
Or you could say every CSS file in any sub folder,

02:48.578 --> 02:50.910
this is what this pattern would say.

02:50.910 --> 02:53.520
So you can also set up glob patterns like this

02:53.520 --> 02:56.010
or directly point at the file you want to use

02:56.010 --> 02:57.030
without the hash.

02:57.030 --> 02:59.520
Because you can't know the hash in advance,

02:59.520 --> 03:01.398
Angular will generate that automatically,

03:01.398 --> 03:04.170
will take the unhashed file names here,

03:04.170 --> 03:06.630
and then automatically generate a service worker

03:06.630 --> 03:09.317
which will take the hashes into account.

03:09.317 --> 03:12.528
Now here we get a second asset group for,

03:12.528 --> 03:15.155
well basically all images we (indistinct) on.

03:15.155 --> 03:18.600
It differs from the first one in, regarding the fact

03:18.600 --> 03:21.270
that it's only pre-loading data if we need them,

03:21.270 --> 03:24.022
if we visited them, or used them at least once.

03:24.022 --> 03:27.810
And this is leading to the behavior we have right now.

03:27.810 --> 03:29.850
Now we got one of our static asset

03:29.850 --> 03:31.399
which is not included here.

03:31.399 --> 03:33.570
And that is our external font.

03:33.570 --> 03:36.270
It's not changing, or at least not regularly,

03:36.270 --> 03:39.930
so we can treat it as static, but it's not included here

03:39.930 --> 03:42.360
because it's not one of our files.

03:42.360 --> 03:45.090
But we can take it from the index HTML file

03:45.090 --> 03:47.370
by just copying that entire link,

03:47.370 --> 03:49.560
which will be requested eventually,

03:49.560 --> 03:52.214
and then we can go back to the ngsw-config file.

03:52.214 --> 03:55.421
And there we tell Angular that we also want to cache this.

03:55.421 --> 03:57.510
Now we don't add it to Files

03:57.510 --> 03:59.550
because this is for local files.

03:59.550 --> 04:02.520
There is an additional resource type you can define

04:02.520 --> 04:04.290
and that is URLs.

04:04.290 --> 04:05.584
It's also an array of strings

04:05.584 --> 04:08.850
but here we put URLs like this one, which are reaching

04:08.850 --> 04:12.840
out to our servers to then fetch resources from there.

04:12.840 --> 04:15.510
With that added, let's save that file,

04:15.510 --> 04:17.970
quit your server down there,

04:17.970 --> 04:21.600
and let's go back into our root project folder.

04:21.600 --> 04:25.163
And let's create another build with ng build --prod,

04:25.163 --> 04:26.340
like this.

04:26.340 --> 04:30.630
And once this is done and we revisit the dist folder

04:30.630 --> 04:32.850
and surf that again, we should see

04:32.850 --> 04:35.320
that the font is also loaded

04:36.360 --> 04:37.710
in an offline mode.

04:37.710 --> 04:41.190
So we go into the dist folder, into angular-pwa,

04:41.190 --> 04:45.333
rerun that HTTP server command, and let's reload that page.

04:46.590 --> 04:49.890
And with it reloaded, and you might also close it

04:49.890 --> 04:53.040
and open a new tab to ensure that the new service worker

04:53.040 --> 04:56.790
gets really loaded and it's not still using an old one.

04:56.790 --> 05:00.600
With that loaded, you can take that offline box here again.

05:00.600 --> 05:04.500
Or, since I always needed to do that, simply turn Wi-Fi off.

05:04.500 --> 05:06.570
Go to the Network tab to see all requests

05:06.570 --> 05:07.770
and reload the page.

05:07.770 --> 05:08.694
And now you should see

05:08.694 --> 05:12.210
that the font here also is not marked as red

05:12.210 --> 05:15.900
but is actually loading the font as it should.

05:15.900 --> 05:17.250
So this is now also working.

05:17.250 --> 05:21.270
It's now also fetching dist and we're still, or now again,

05:21.270 --> 05:24.090
able to use it in offline mode, that font.

05:24.090 --> 05:25.537
Now what about the API?
