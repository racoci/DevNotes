# 716. Adding Service Workers

> Duração: `13min`

Sem Recursos

WEBVTT

00:02.250 --> 00:03.750
-: Let's first of all understand

00:03.750 --> 00:07.230
what a service worker actually is.

00:07.230 --> 00:10.710
Now this is how our JavaScript code typically behaves.

00:10.710 --> 00:12.420
It runs in a single thread.

00:12.420 --> 00:14.910
That means our web application,

00:14.910 --> 00:17.520
which can consist of multiple pages,

00:17.520 --> 00:21.210
or, in the case of an Angular app, with one page only.

00:21.210 --> 00:24.810
This app often uses JavaScript and if you're using Angular,

00:24.810 --> 00:26.280
you're, of course, using JavaScript

00:26.280 --> 00:28.800
because Angular uses JavaScript.

00:28.800 --> 00:31.380
So this JavaScript code, the entire Angular app

00:31.380 --> 00:36.360
runs on one single thread and JavaScript has its features

00:36.360 --> 00:38.250
to still handle asynchronous code

00:38.250 --> 00:39.900
and not block the execution.

00:39.900 --> 00:42.120
But this is all normal JavaScript.

00:42.120 --> 00:45.900
Now JavaScript and the browser also offers us

00:45.900 --> 00:48.420
to run an additional thread.

00:48.420 --> 00:51.420
We can run a so-called web worker

00:51.420 --> 00:54.240
and a special form of that is the service worker

00:54.240 --> 00:55.650
on another thread.

00:55.650 --> 00:58.440
So this still then uses one of the same thread

00:58.440 --> 01:01.740
but it's a different thread than your main JavaScript code.

01:01.740 --> 01:04.470
And the important part is that this thread

01:04.470 --> 01:07.830
is kind of decoupled from your HTML pages.

01:07.830 --> 01:10.440
So this means that this can also continue running

01:10.440 --> 01:13.230
in the background, for example, on your mobile phone,

01:13.230 --> 01:15.960
that is something mobile browsers typically offer.

01:15.960 --> 01:17.880
This can continue running

01:17.880 --> 01:20.220
and could it could, therefore, also do advanced things

01:20.220 --> 01:22.800
like receive push notifications,

01:22.800 --> 01:24.960
take my full progressive web app course

01:24.960 --> 01:26.700
if you wanna learn more about this.

01:26.700 --> 01:29.370
But one other crucial thing that a service worker can do

01:29.370 --> 01:32.580
is it can manage all your different pages

01:32.580 --> 01:34.200
in case you got multiple pages

01:34.200 --> 01:36.720
or your single page if you're building an Angular app.

01:36.720 --> 01:40.920
And it can listen to outgoing networks request.

01:40.920 --> 01:45.920
So it can listen to requests going out of your webpage.

01:45.930 --> 01:48.240
For example, if you are fetching the assets

01:48.240 --> 01:52.200
of that webpage, the CSS code, the font, the JavaScript,

01:52.200 --> 01:54.810
or also data from an API.

01:54.810 --> 01:58.200
The service worker can catch these outgoing requests

01:58.200 --> 01:59.550
and do something with them.

01:59.550 --> 02:02.640
Like, for example, cache the responses

02:02.640 --> 02:05.130
in a special cache storage

02:05.130 --> 02:08.610
or then also return these cached responses

02:08.610 --> 02:11.220
back to your page so that it also works

02:11.220 --> 02:13.200
if you got no internet connection,

02:13.200 --> 02:16.380
of course, only if there is a cached version available.

02:16.380 --> 02:18.090
This is what the service worker does.

02:18.090 --> 02:21.900
It can be seen as a proxy between your app,

02:21.900 --> 02:25.470
your front end app, and the HDP request

02:25.470 --> 02:26.820
you're sending to the backend.

02:26.820 --> 02:29.850
It proxies that request, which means it caches it,

02:29.850 --> 02:31.110
does something with it,

02:31.110 --> 02:34.470
and might then allow it to still go on and leave the app,

02:34.470 --> 02:36.540
but it could also block this.

02:36.540 --> 02:39.750
Now configuring such a service worker and writing it

02:39.750 --> 02:42.660
from scratch is something you can do and something you learn

02:42.660 --> 02:44.970
in my full progressive web app course.

02:44.970 --> 02:47.700
There you also learn about features like push notifications

02:47.700 --> 02:49.020
and so on.

02:49.020 --> 02:51.780
For this video, we'll focus on how Angular

02:51.780 --> 02:56.100
can easily add such a service worker to our Angular app

02:56.100 --> 02:58.410
because it turns out that there is a special package

02:58.410 --> 02:59.670
we can install.

02:59.670 --> 03:01.410
For that, let's quit NG Serve.

03:01.410 --> 03:03.900
And now here it's important that you're using

03:03.900 --> 03:06.900
the latest CLI version for that project

03:06.900 --> 03:08.220
and this project does.

03:08.220 --> 03:13.220
And then you can run NG add to add third party package,

03:14.190 --> 03:16.500
but that's more than just a NPM library

03:16.500 --> 03:20.010
really some functionality to your app

03:20.010 --> 03:24.030
and only some features can be edited because, essentially,

03:24.030 --> 03:27.000
this will execute a command which has to be defined

03:27.000 --> 03:29.730
by whichever package you are targeting.

03:29.730 --> 03:31.830
So not every, not even close.

03:31.830 --> 03:35.160
not every third party library supports this feature

03:35.160 --> 03:37.770
but there is a special library which does support it

03:37.770 --> 03:41.490
which you can target with add @angular/pwa.

03:41.490 --> 03:43.020
And if you run this,

03:43.020 --> 03:46.050
this will actually configure your existing project

03:46.050 --> 03:49.200
to use the Angular service worker package

03:49.200 --> 03:52.170
and start with a pre-configured service worker.

03:52.170 --> 03:54.030
So it does a lot for you.

03:54.030 --> 03:55.980
You can already see it added some things

03:55.980 --> 03:59.010
to the index html file like the no script section

03:59.010 --> 04:01.050
to give a warning if JavaScript is turned off

04:01.050 --> 04:04.200
because we need that, of course, we need that turned on.

04:04.200 --> 04:07.650
It loads this manifest here, which it all generated.

04:07.650 --> 04:11.220
Now that is important for actually having a launcher icon

04:11.220 --> 04:12.180
for your app.

04:12.180 --> 04:13.560
If you have it on a mobile phone,

04:13.560 --> 04:15.060
you can even save it to the home screen

04:15.060 --> 04:16.500
and then start it with that

04:16.500 --> 04:19.620
and you can define which icon that should use and so on.

04:19.620 --> 04:21.630
So that is the manifest adjacent file.

04:21.630 --> 04:24.210
Again, learn more in that course I mentioned.

04:24.210 --> 04:27.240
For us interesting is the app module

04:27.240 --> 04:28.620
because, in the app module,

04:28.620 --> 04:30.840
we are using a service worker module

04:30.840 --> 04:33.780
which is imported from @angular service worker.

04:33.780 --> 04:35.550
And this is really an official package

04:35.550 --> 04:38.520
of the Angular framework and it does what it sounds like.

04:38.520 --> 04:41.010
It registers a service worker

04:41.010 --> 04:44.760
which will be that proxy that catches outgoing requests

04:44.760 --> 04:46.200
and does something with them

04:46.200 --> 04:48.510
and you will learn how to configure what it does

04:48.510 --> 04:51.510
to them later in this video, of course.

04:51.510 --> 04:53.850
We use it here by calling the register method.

04:53.850 --> 04:58.440
And there we target the NGSW worker.js file

04:58.440 --> 05:01.050
and you won't find that file here.

05:01.050 --> 05:03.240
And the reason for that is that this file

05:03.240 --> 05:05.850
will actually be auto-generated,

05:05.850 --> 05:08.580
it will be generated during the built process

05:08.580 --> 05:10.860
and it will be in the disc folder, therefore.

05:10.860 --> 05:13.140
And it will hold your service worker,

05:13.140 --> 05:15.150
which will contain a lot of functionality

05:15.150 --> 05:17.610
which you don't have to, and typically don't want to,

05:17.610 --> 05:19.230
write on your own.

05:19.230 --> 05:21.480
And here it's all the configured to only be added

05:21.480 --> 05:23.343
if you're building for production.

05:24.660 --> 05:27.030
In the assets folder, we see some icons were added

05:27.030 --> 05:29.010
for that manifest adjacent file.

05:29.010 --> 05:31.080
And in the root project folder,

05:31.080 --> 05:33.630
we see that in the package adjacent file, something changed.

05:33.630 --> 05:36.420
For example, the Angular PWA package was added

05:36.420 --> 05:39.810
which includes that angular service worker package.

05:39.810 --> 05:42.630
And we got this NGSW conflict file.

05:42.630 --> 05:44.490
This is the file where you can configure

05:44.490 --> 05:46.950
that service worker which will be generated,

05:46.950 --> 05:49.440
but we'll take a closer look at this in a second.

05:49.440 --> 05:52.950
The angular.json file, which manages to see live project

05:52.950 --> 05:55.140
also was adjusted a little bit.

05:55.140 --> 05:57.570
There service worker is set to true

05:57.570 --> 05:59.340
for the production build.

05:59.340 --> 06:01.680
This is required because the service worker

06:01.680 --> 06:03.990
will cache certain resources

06:03.990 --> 06:08.250
and to ensure that the new build updates the service worker,

06:08.250 --> 06:10.530
these resources will contain a hash

06:10.530 --> 06:14.100
and that will then also be injected into the service worker

06:14.100 --> 06:16.170
which is why we need to make the build process

06:16.170 --> 06:18.930
aware of the fact that we need a service worker.

06:18.930 --> 06:20.250
This is how that works.

06:20.250 --> 06:21.810
Now let's simply see that in action.

06:21.810 --> 06:23.730
Let's create a production build

06:23.730 --> 06:26.580
by running ng build --prod

06:26.580 --> 06:29.340
and this will now bundle and optimize the entire app,

06:29.340 --> 06:31.440
use ahead of time compilation and so on,

06:31.440 --> 06:35.250
and it will spit out our Angular app in a dist folder.

06:35.250 --> 06:37.770
And there we should then also see the service worker.

06:37.770 --> 06:39.480
So, let's have a look.

06:39.480 --> 06:41.220
If we close the source tab here,

06:41.220 --> 06:43.620
let's refresh, here's the dist folder,

06:43.620 --> 06:45.990
the angler-pwa folder for the project.

06:45.990 --> 06:49.890
And there we see that ngsq-worker.js file.

06:49.890 --> 06:53.190
You remember that is the file we are importing

06:53.190 --> 06:54.330
in the app module here.

06:54.330 --> 06:56.340
We're registering it here.

06:56.340 --> 06:59.190
So this can be found in the dist folder, indeed.

06:59.190 --> 07:00.180
If we have a look at it,

07:00.180 --> 07:03.120
you see there's a lot of code in there because, well,

07:03.120 --> 07:06.180
it's actually pre-generated for you to do all that caching

07:06.180 --> 07:08.910
and so on in a very efficient way.

07:08.910 --> 07:11.460
And now let's simply do what it,

07:11.460 --> 07:13.290
let's simply see what it does.

07:13.290 --> 07:17.310
And for that you need a web server you can run,

07:17.310 --> 07:20.160
to host your production app here.

07:20.160 --> 07:24.420
You could do that with ng serve --prod,

07:24.420 --> 07:26.640
but there you will actually not see the service worker

07:26.640 --> 07:30.420
in action correctly because it will only build it in memory.

07:30.420 --> 07:31.890
So, therefore, what you should do

07:31.890 --> 07:34.590
is install a lightweight node server.

07:34.590 --> 07:36.090
And, thankfully, there is one.

07:36.090 --> 07:39.300
You can install it with npm install -g

07:39.300 --> 07:40.950
to install it globally.

07:40.950 --> 07:43.170
Http-server.

07:43.170 --> 07:45.960
This is a package you can use to launch a simple

07:45.960 --> 07:49.080
node based server, which will host the content

07:49.080 --> 07:51.210
of the folder you run the command in.

07:51.210 --> 07:56.210
And the command you need to run is just http-server.

07:57.510 --> 08:00.540
So let's navigate into our dist folder

08:00.540 --> 08:03.240
and there in the angular-pwa folder

08:03.240 --> 08:06.780
and let's run http-server.

08:06.780 --> 08:09.720
And then you can assign a port with -p 8081,

08:09.720 --> 08:12.600
for example, and it will then bring this up.

08:12.600 --> 08:17.600
And now you can visit local host 8081

08:17.760 --> 08:19.950
and you should see your Angular app there.

08:19.950 --> 08:21.720
Now this app looks like a normal app.

08:21.720 --> 08:24.360
Now reload it once to make sure that the service worker

08:24.360 --> 08:27.180
can do its work and go to application again.

08:27.180 --> 08:29.640
We should now see that under application

08:29.640 --> 08:32.190
we got that ngsw-worker running.

08:32.190 --> 08:33.030
And if you don't see that,

08:33.030 --> 08:35.280
try reloading that page one more time,

08:35.280 --> 08:37.980
also make sure to clear the storage here entirely.

08:37.980 --> 08:41.490
If you worked with service workers and this port served

08:41.490 --> 08:45.060
on your local domain before, now you should see that.

08:45.060 --> 08:48.120
The interesting part is if I now take offline again

08:48.120 --> 08:50.850
and I reload, it still works, right?

08:50.850 --> 08:54.090
We still see the same content as before,

08:54.090 --> 08:56.010
even though we're offline.

08:56.010 --> 08:58.020
Now, how can that work?

08:58.020 --> 09:00.990
If we go to the network tab and we clear it

09:00.990 --> 09:04.350
and we now reload, we see we're making a bunch of requests

09:04.350 --> 09:07.140
here and they're all essentially served

09:07.140 --> 09:09.780
from the ng service worker here.

09:09.780 --> 09:12.330
So, from the service worker, this is all served.

09:12.330 --> 09:15.120
The interesting part is to post request here probably

09:15.120 --> 09:17.160
which is still kind of can connect

09:17.160 --> 09:20.130
to the outgoing server for that.

09:20.130 --> 09:24.483
Let's again, disable wifi and let's try this again.

09:26.100 --> 09:27.240
And now this does not work.

09:27.240 --> 09:30.000
But what we can see still is that, for one,

09:30.000 --> 09:32.580
there is a bug or an intended behavior in Chrome

09:32.580 --> 09:35.430
which leads to these API requests still going through

09:35.430 --> 09:37.740
even if we simulate offline mode.

09:37.740 --> 09:40.260
But more interestingly, we see a white page,

09:40.260 --> 09:44.430
we don't see that there is no internet connection error.

09:44.430 --> 09:46.530
Now we would not just see a white page,

09:46.530 --> 09:51.530
we would see any content we add here if we load our page.

09:51.690 --> 09:54.030
So we essentially see everything that's hard coded

09:54.030 --> 09:55.710
into our Angular app.

09:55.710 --> 09:57.600
The dynamic content is missing.

09:57.600 --> 09:59.400
We'll take a look at this in a second,

09:59.400 --> 10:01.830
but all the hard coded content is there

10:01.830 --> 10:04.410
because what we can see in the network tab

10:04.410 --> 10:07.020
is that we're loading the main page.

10:07.020 --> 10:10.710
The styles, not the font, but the styles,

10:10.710 --> 10:12.240
the JavaScript files,

10:12.240 --> 10:14.760
all that is loaded from the service worker

10:14.760 --> 10:19.760
and the failing things are the font and our posts.

10:20.310 --> 10:22.660
Let me turn wifi back on

10:24.210 --> 10:25.920
and also leave that simulation mode,

10:25.920 --> 10:28.545
which didn't work too great, I guess.

10:28.545 --> 10:31.380
And now, of course, if I reload it again works

10:31.380 --> 10:33.900
and let's now change something.

10:33.900 --> 10:35.580
First of all, let's change something

10:35.580 --> 10:37.440
at the app component.

10:37.440 --> 10:42.440
There I'll add an h1 tech, raise save my posts.

10:42.630 --> 10:46.410
Now let's quit that HDP server, go back into domain folder,

10:46.410 --> 10:49.620
and let's run ng build --prod again.

10:49.620 --> 10:52.380
And let's see how this now changes the app.

10:52.380 --> 10:55.260
And if I'm right regarding my statement,

10:55.260 --> 10:58.560
that hard coded content would be cached.

10:58.560 --> 11:02.310
So let's wait for this to finish, for that build to finish.

11:02.310 --> 11:06.630
And once it's finished, let's go back into that dist folder

11:06.630 --> 11:09.480
and there into that angular-pwa folder.

11:09.480 --> 11:12.240
And let's run our server command again.

11:12.240 --> 11:14.880
So HDP server on that port,

11:14.880 --> 11:17.580
let's reload the application here

11:17.580 --> 11:19.620
and you might need to reload twice

11:19.620 --> 11:21.360
and you shouldn't see my posts.

11:21.360 --> 11:24.720
The reason for the double reload is that the service worker

11:24.720 --> 11:28.710
was loaded and the service worker is aware of the fact

11:28.710 --> 11:32.580
that the index html file changed or that the script

11:32.580 --> 11:35.820
rendering content to it changed, to be precise,

11:35.820 --> 11:38.220
because of that hashing thing I mentioned.

11:38.220 --> 11:40.770
This hash table, which is automatically generated

11:40.770 --> 11:43.080
and all the files having hashes

11:43.080 --> 11:44.760
because, by default, it would, of course,

11:44.760 --> 11:46.890
fetch these resources from the cache.

11:46.890 --> 11:48.480
So we would see the old version.

11:48.480 --> 11:49.560
We don't want that.

11:49.560 --> 11:52.980
So we take the new version by, or we let us give

11:52.980 --> 11:56.610
the new version by using that angular service worker package

11:56.610 --> 11:58.140
which takes care about the hashing

11:58.140 --> 12:00.240
and the fact that the service worker is aware

12:00.240 --> 12:02.430
of the new version for us.

12:02.430 --> 12:03.960
So we get that.

12:03.960 --> 12:06.780
Now, if I go offline again,

12:06.780 --> 12:09.210
you see that is also part of the loaded page.

12:09.210 --> 12:11.880
And if I go fully offline by turning off wifi,

12:11.880 --> 12:13.290
we still see that.

12:13.290 --> 12:18.290
So now the font and the API call, the API data is missing,

12:18.360 --> 12:19.410
I should say.

12:19.410 --> 12:22.830
So that is what I now want to change and to change this,

12:22.830 --> 12:25.980
and get that same page here when we're offline

12:25.980 --> 12:27.870
as I'm getting when I'm online,

12:27.870 --> 12:30.060
we need to change the service worker config,

12:30.060 --> 12:33.870
which can be done in the ngsw-config.json file.

12:33.870 --> 12:35.490
Now in this file you can configure

12:35.490 --> 12:37.740
how the angular service worker behaves.

12:37.740 --> 12:39.140
So let's take a closer look.
