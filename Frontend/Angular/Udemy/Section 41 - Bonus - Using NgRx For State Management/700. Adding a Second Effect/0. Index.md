# 700. Adding a Second Effect

> Duração: `10min`

Sem Recursos

WEBVTT

1
00:00:02.040 --> 00:00:03.360
<v Maximilian>So now we already learned</v>

2
00:00:03.360 --> 00:00:04.920
quite a bit about effects.

3
00:00:04.920 --> 00:00:08.130
To finish this part about effects here,

4
00:00:08.130 --> 00:00:10.020
I now want to add a second effect

5
00:00:10.020 --> 00:00:13.650
which actually loads the data from local storage.

6
00:00:13.650 --> 00:00:15.570
And this is now an effect

7
00:00:15.570 --> 00:00:18.930
that should then actually dispatch a new action

8
00:00:18.930 --> 00:00:20.790
once it's done.

9
00:00:20.790 --> 00:00:24.330
A new action that will take that counter

10
00:00:24.330 --> 00:00:26.790
that was extracted from local storage

11
00:00:26.790 --> 00:00:29.370
and store it in our NgRx store,

12
00:00:29.370 --> 00:00:32.250
so that when we basically reload the app,

13
00:00:32.250 --> 00:00:35.223
we continue with the counter we stored before.

14
00:00:36.300 --> 00:00:40.383
To make this all work, I need to add two new actions though.

15
00:00:41.340 --> 00:00:45.270
I need one new action which could be called init,

16
00:00:45.270 --> 00:00:49.860
which should, in the end, trigger this side effect pipeline

17
00:00:49.860 --> 00:00:54.090
that reaches out to local storage and loads data from it.

18
00:00:54.090 --> 00:00:57.270
For this, I'll create it here with createAction

19
00:00:57.270 --> 00:01:01.080
or of course, also with this alternative syntax,

20
00:01:01.080 --> 00:01:02.580
but here I'll use createAction

21
00:01:04.110 --> 00:01:06.330
and give it this identifier.

22
00:01:06.330 --> 00:01:08.700
And here, I don't need any extra payload,

23
00:01:08.700 --> 00:01:11.853
I don't need any extra data attached to the action.

24
00:01:12.900 --> 00:01:16.530
But I'll then add a second action here,

25
00:01:16.530 --> 00:01:18.363
which I'll simply name as set.

26
00:01:19.285 --> 00:01:22.050
I also created with createAction

27
00:01:22.050 --> 00:01:25.830
where the identifier should be Counter Set.

28
00:01:25.830 --> 00:01:28.050
But where I now do want to have some

29
00:01:28.050 --> 00:01:29.850
value attached to it again,

30
00:01:29.850 --> 00:01:33.330
and the value here should again be the number

31
00:01:33.330 --> 00:01:35.520
to which we set the counter.

32
00:01:35.520 --> 00:01:40.050
And therefore again, here I'll add this kind of shape

33
00:01:40.050 --> 00:01:42.963
for the data that is attached to the action.

34
00:01:45.000 --> 00:01:47.130
With these two actions added,

35
00:01:47.130 --> 00:01:50.490
I have one action now that will trigger the side effect

36
00:01:50.490 --> 00:01:52.440
and one action that should be dispatched

37
00:01:52.440 --> 00:01:54.240
once the side effect is done,

38
00:01:54.240 --> 00:01:56.703
to then be handled in the reducer.

39
00:01:57.840 --> 00:02:00.150
Therefore, I'll start in the reducer actually

40
00:02:00.150 --> 00:02:03.240
and add another on branch to it.

41
00:02:03.240 --> 00:02:07.830
So to say, where I now listen for the set action,

42
00:02:07.830 --> 00:02:09.510
which again, should be dispatched

43
00:02:09.510 --> 00:02:12.543
once we loaded data with help of our side effect.

44
00:02:13.950 --> 00:02:17.250
And here I then got my state and my action

45
00:02:17.250 --> 00:02:20.100
and I know that my action will carry the data

46
00:02:20.100 --> 00:02:21.900
to which the state should be set.

47
00:02:21.900 --> 00:02:25.860
Therefore here, I simply return action.value.

48
00:02:25.860 --> 00:02:28.410
I don't even care about the existing state.

49
00:02:28.410 --> 00:02:31.530
Instead, I'll set my state to the payload

50
00:02:31.530 --> 00:02:33.330
that is attached to the action

51
00:02:33.330 --> 00:02:35.610
because that will be the counter value

52
00:02:35.610 --> 00:02:38.550
that will be retrieved from local storage.

53
00:02:38.550 --> 00:02:41.433
But of course, we now have to add the logic for this.

54
00:02:42.360 --> 00:02:44.670
And for this back here in CounterEffects,

55
00:02:44.670 --> 00:02:48.300
we can add a new property, loadCount

56
00:02:48.300 --> 00:02:49.893
with help of createEffect.

57
00:02:51.660 --> 00:02:54.270
And we again, pass our function to createEffect

58
00:02:54.270 --> 00:02:57.090
where we build another effect pipeline

59
00:02:57.090 --> 00:02:59.523
with help of this.actions$.pipe.

60
00:03:00.510 --> 00:03:03.450
And then here, we pass ofType here

61
00:03:03.450 --> 00:03:05.520
to define for which kind of action

62
00:03:05.520 --> 00:03:07.740
this pipeline should be executed.

63
00:03:07.740 --> 00:03:10.500
And here, that's for the init action,

64
00:03:10.500 --> 00:03:14.070
which must be imported from the actions file.

65
00:03:14.070 --> 00:03:16.860
And we'll make sure to dispatch this action

66
00:03:16.860 --> 00:03:19.533
from somewhere in our application soon.

67
00:03:20.670 --> 00:03:22.110
So with that, we got the filter.

68
00:03:22.110 --> 00:03:23.820
And here, it's only one action

69
00:03:23.820 --> 00:03:25.830
that should trigger this side effect,

70
00:03:25.830 --> 00:03:28.380
so other actions will not trigger it.

71
00:03:28.380 --> 00:03:30.210
And for example, the init action

72
00:03:30.210 --> 00:03:32.490
would not trigger this side effect here,

73
00:03:32.490 --> 00:03:34.800
this saveCount side effect

74
00:03:34.800 --> 00:03:36.510
because here, we're only listening

75
00:03:36.510 --> 00:03:39.630
for increment and decrement actions.

76
00:03:39.630 --> 00:03:42.870
But in the loadCount side effect pipeline here,

77
00:03:42.870 --> 00:03:45.450
we then wanna continue

78
00:03:45.450 --> 00:03:49.470
by getting some data from our local storage.

79
00:03:49.470 --> 00:03:52.950
And for this, we can use the switchMap operator

80
00:03:52.950 --> 00:03:54.720
offered by RxJS,

81
00:03:54.720 --> 00:03:58.510
which simply allows us to switch to a new observable chain

82
00:03:59.820 --> 00:04:03.540
where we then start by getting some value

83
00:04:03.540 --> 00:04:05.190
from local storage.

84
00:04:05.190 --> 00:04:08.410
And for that, we want to use localStorage.getItem

85
00:04:09.540 --> 00:04:12.060
and get the item stored under the key count

86
00:04:12.060 --> 00:04:14.130
because that's the key I'm using down here

87
00:04:14.130 --> 00:04:16.350
for storing the value.

88
00:04:16.350 --> 00:04:18.450
So that's then my storedCounter.

89
00:04:19.620 --> 00:04:22.800
And then the new value we wanna return here

90
00:04:22.800 --> 00:04:25.200
should be a new observable

91
00:04:25.200 --> 00:04:27.000
that in the end is wrapped around

92
00:04:27.000 --> 00:04:29.760
an action we wanna dispatch.

93
00:04:29.760 --> 00:04:33.393
And for that, we can simply call set.

94
00:04:34.380 --> 00:04:39.380
So this set action which is imported from the actions file,

95
00:04:39.870 --> 00:04:42.270
which creates such an action object.

96
00:04:42.270 --> 00:04:46.590
And here, I then set the value equal to my storedCounter.

97
00:04:46.590 --> 00:04:48.840
However, here I want to convert this to a number

98
00:04:48.840 --> 00:04:50.973
and therefore, add a plus in front of it.

99
00:04:52.860 --> 00:04:54.930
Now stored counter could be null,

100
00:04:54.930 --> 00:04:57.690
if no value is found under that key.

101
00:04:57.690 --> 00:05:00.000
And therefore, I'll actually add a if check

102
00:05:00.000 --> 00:05:04.560
and check if storedCounter is truthy.

103
00:05:04.560 --> 00:05:07.800
in which case, I'll return this action

104
00:05:07.800 --> 00:05:11.310
wrapped around this counter convert it to a number.

105
00:05:11.310 --> 00:05:16.310
Alternatively, I'll execute set with a value of zero.

106
00:05:16.800 --> 00:05:18.930
So if we have no counter stored yet,

107
00:05:18.930 --> 00:05:22.593
we'll just start with zero as a counter value.

108
00:05:24.150 --> 00:05:25.980
So with that, we're almost there

109
00:05:25.980 --> 00:05:29.370
but switchMap actually needs an observable

110
00:05:29.370 --> 00:05:34.200
to be returned by this function and not an action object.

111
00:05:34.200 --> 00:05:36.960
And therefore, we should turn this action object

112
00:05:36.960 --> 00:05:38.430
into an observable

113
00:05:38.430 --> 00:05:42.900
by using the of operator which is imported from RxJS,

114
00:05:44.790 --> 00:05:47.040
which is simply a function we can execute

115
00:05:47.040 --> 00:05:48.990
to wrap it around the value

116
00:05:48.990 --> 00:05:52.230
which will then be wrapped into an observable.

117
00:05:52.230 --> 00:05:54.420
And with that, switchMap is happy

118
00:05:54.420 --> 00:05:56.913
once I wrapped both action objects with of.

119
00:05:57.870 --> 00:06:00.990
And with that, we also finished this effect pipeline

120
00:06:00.990 --> 00:06:04.230
which will now load some data from local storage

121
00:06:04.230 --> 00:06:06.420
and which will then in the end

122
00:06:06.420 --> 00:06:08.853
dispatch a new action once it's done.

123
00:06:10.260 --> 00:06:12.600
And therefore here, since this pipeline

124
00:06:12.600 --> 00:06:16.080
does in the end yield a new action object,

125
00:06:16.080 --> 00:06:19.440
which is the default for NgRx effects,

126
00:06:19.440 --> 00:06:22.830
which is kind of expected by NgRx effects,

127
00:06:22.830 --> 00:06:27.600
we should not add this dispatch: false configuration object

128
00:06:27.600 --> 00:06:29.670
to create effect.

129
00:06:29.670 --> 00:06:33.360
That was only required before for this pipeline

130
00:06:33.360 --> 00:06:37.200
where we did indeed not yield a new action object

131
00:06:37.200 --> 00:06:38.640
as a final result.

132
00:06:38.640 --> 00:06:42.003
Here, that's different, so we don't set dispatch to false.

133
00:06:42.870 --> 00:06:44.970
And with that, we're almost there.

134
00:06:44.970 --> 00:06:46.590
We now just have to make sure

135
00:06:46.590 --> 00:06:49.920
that this init action gets dispatched somewhere,

136
00:06:49.920 --> 00:06:52.083
so that this pipeline gets started.

137
00:06:53.070 --> 00:06:54.420
And of course it's up to you

138
00:06:54.420 --> 00:06:56.310
where you want to initialize your app.

139
00:06:56.310 --> 00:06:58.260
Here, for me, I would say it makes sense

140
00:06:58.260 --> 00:07:00.030
to do this in the AppComponent

141
00:07:00.030 --> 00:07:03.270
because I know that this demo app needs a counter,

142
00:07:03.270 --> 00:07:06.660
so I wanna dispatch this initializing action

143
00:07:06.660 --> 00:07:08.790
as early as possible.

144
00:07:08.790 --> 00:07:13.380
Therefore, I'll implement OnInit here in the AppComponent

145
00:07:13.380 --> 00:07:15.960
and then add ngOnInit,

146
00:07:15.960 --> 00:07:17.820
this ngOnInit function here,

147
00:07:17.820 --> 00:07:21.150
so that in here, we can dispatch this action.

148
00:07:21.150 --> 00:07:25.740
For that, of course, we also should inject the Store

149
00:07:25.740 --> 00:07:30.480
by also importing NgRx store, like this.

150
00:07:30.480 --> 00:07:32.160
So that inset of ngOnInit,

151
00:07:32.160 --> 00:07:35.670
we can use this.store to call dispatch

152
00:07:35.670 --> 00:07:38.610
and dispatch this init action

153
00:07:38.610 --> 00:07:40.560
by calling this init function

154
00:07:40.560 --> 00:07:43.293
which is imported from the counter.actions file.

155
00:07:44.940 --> 00:07:47.700
And here we, don't pass any data to init

156
00:07:47.700 --> 00:07:51.900
because the init action indeed is an action

157
00:07:51.900 --> 00:07:54.603
that does not require any extra data.

158
00:07:55.590 --> 00:07:56.423
So with that,

159
00:07:56.423 --> 00:07:59.220
we're dispatching this basically when the app starts

160
00:07:59.220 --> 00:08:03.060
and that then kicks off this side effect pipeline here,

161
00:08:03.060 --> 00:08:06.720
which loads data and dispatches another new action,

162
00:08:06.720 --> 00:08:10.530
which is then handled by the reducer.

163
00:08:10.530 --> 00:08:14.010
And that should load any already stored counter

164
00:08:14.010 --> 00:08:16.530
when our app runs.

165
00:08:16.530 --> 00:08:20.550
So if you now save all files and you run ng serve,

166
00:08:20.550 --> 00:08:21.960
if you restart the app,

167
00:08:21.960 --> 00:08:24.270
you should indeed start with the counter

168
00:08:24.270 --> 00:08:26.580
that was already stored in local storage.

169
00:08:26.580 --> 00:08:29.550
And if you change that counter and you restart,

170
00:08:29.550 --> 00:08:32.310
you should start with that updated counter.

171
00:08:32.310 --> 00:08:35.040
If you delete that value from local storage,

172
00:08:35.040 --> 00:08:37.200
you should start with zero.

173
00:08:37.200 --> 00:08:39.270
But then as soon as you change it again,

174
00:08:39.270 --> 00:08:40.770
that value gets stored

175
00:08:40.770 --> 00:08:44.490
and gets used for follow up restarts of the app.

176
00:08:44.490 --> 00:08:46.590
And of course, it should be needless to mention

177
00:08:46.590 --> 00:08:48.210
but this code works

178
00:08:48.210 --> 00:08:51.540
no matter if you're using Angular modules

179
00:08:51.540 --> 00:08:53.850
or standalone components.

180
00:08:53.850 --> 00:08:56.940
So I'll copy over all that code

181
00:08:56.940 --> 00:09:00.310
from the reducer effects and actions files

182
00:09:01.560 --> 00:09:04.870
into the standalone Angular component

183
00:09:05.820 --> 00:09:09.900
and also use that AppComponent code

184
00:09:09.900 --> 00:09:12.030
in the standalone component here.

185
00:09:12.030 --> 00:09:14.400
Though there of course, I must make sure

186
00:09:14.400 --> 00:09:17.310
that I don't lose standalone and my imports,

187
00:09:17.310 --> 00:09:19.920
so I will actually just copy the constructor

188
00:09:19.920 --> 00:09:23.460
and ngOnInit into the AppComponent

189
00:09:23.460 --> 00:09:27.870
and implement OnInit here,

190
00:09:27.870 --> 00:09:30.210
and also add that OnInit import,

191
00:09:30.210 --> 00:09:34.500
and of course, also add the imports of init and store.

192
00:09:34.500 --> 00:09:38.430
So these lines of code are also required here.

193
00:09:38.430 --> 00:09:41.040
And with all that, of course,

194
00:09:41.040 --> 00:09:44.820
if you give this a try and we start this application here

195
00:09:44.820 --> 00:09:47.160
with standalone components,

196
00:09:47.160 --> 00:09:49.440
we still load that counter, change it,

197
00:09:49.440 --> 00:09:52.890
save that counter and restart with that saved counter.

198
00:09:52.890 --> 00:09:56.043
And that's how you can use NgRx effects.

